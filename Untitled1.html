<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aniket Milk App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: #f0f2f5; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
    .container { max-width: 900px; margin: auto; background: #fff; min-height: 100vh; position: relative; }
    .hidden { display: none !important; }
    
    /* Header Styles */
    h2 { color: #1a73e8; font-size: 24px; margin: 10px 0; }
    .top { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 10; }
    .btn { border: none; border-radius: 8px; padding: 10px 16px; font-size: 16px; cursor: pointer; transition: all 0.3s; font-weight: 600; }
    .add-btn { background: #ff9800; color: #fff; }
    .save-btn { background: #28a745; color: #fff; }
    .pdf-btn { background: #17a2b8; color: #fff; }
    .back-btn { background: #6c757d; color: #fff; }
    .delete-btn { background: #dc3545; color: #fff; }
    .btn:active { transform: scale(0.95); }
    
    /* List Styles */
    .list-item { padding: 18px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 18px; background: #fff; transition: background 0.2s; }
    .list-item:active { background: #e3f2fd; }
    .dots { padding: 8px; cursor: pointer; font-size: 20px; color: #666; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
    .dots:active { background: #f0f0f0; }
    
    /* Notes Styles */
    .note { background: #e8f0fe; padding: 16px; margin: 10px 12px; border-radius: 12px; position: relative; border-left: 4px solid #1a73e8; }
    .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .note-date { font-weight: bold; color: #1a73e8; font-size: 14px; }
    .note-text { font-size: 16px; color: #333; line-height: 1.4; }
    .note-dots { position: absolute; top: 8px; right: 8px; padding: 4px 8px; cursor: pointer; font-size: 18px; color: #666; }
    
    /* Modal Overlay - Blocks all outside interaction */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.6); z-index: 1000; display: flex; 
      align-items: center; justify-content: center; opacity: 0; 
      transition: opacity 0.3s; pointer-events: none; 
    }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    
    /* Modal Box */
    .modal-box { 
      background: #fff; border-radius: 20px; width: 90%; max-width: 400px; 
      max-height: 80vh; overflow-y: auto; transform: scale(0.8) translateY(20px); 
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; 
    }
    .modal-overlay.active .modal-box { transform: scale(1) translateY(0); }
    
    /* Swipe handle for modal */
    .modal-handle { 
      width: 40px; height: 4px; background: #ddd; border-radius: 2px; 
      margin: 12px auto; cursor: grab; 
    }
    .modal-handle:active { cursor: grabbing; }
    
    .modal-header { padding: 20px 20px 10px; border-bottom: 2px solid #f0f0f0; }
    .modal-title { font-size: 20px; font-weight: bold; color: #1a73e8; margin: 0; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px 20px; display: flex; gap: 10px; justify-content: flex-end; }
    
    /* Form Elements */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 14px; color: #666; margin-bottom: 6px; font-weight: 600; }
    .form-input { 
      width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; 
      font-size: 16px; transition: border-color 0.3s; font-family: inherit; 
    }
    .form-input:focus { outline: none; border-color: #1a73e8; }
    textarea.form-input { resize: vertical; min-height: 80px; }
    
    /* Small modal for delete confirmation */
    .modal-small { max-width: 300px; text-align: center; }
    .modal-small .modal-body { padding: 30px 20px; }
    .warning-icon { font-size: 48px; margin-bottom: 10px; }
    
    /* Date input styling */
    input[type="date"] { font-size: 16px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; }
    
    /* Page transitions */
    .page { animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 40px; color: #999; font-size: 16px; }
  </style>
</head>
<body>

<div class="container">
  
  <!-- PAGE 1: Customer List -->
  <div id="pageList" class="page">
    <div class="top">
      <h2>ü•õ Aniket Milk Supply</h2>
      <div style="display: flex; gap: 8px;">
        <button class="btn add-btn" onclick="openAddCustomerModal()">‚ûï</button>
        <button class="btn back-btn" onclick="history.back()">‚Ü©Ô∏è</button>
      </div>
    </div>
    <div id="custList"></div>
  </div>

  <!-- PAGE 2: Customer Detail -->
  <div id="pageDetail" class="hidden page">
    <div class="top">
      <button class="btn back-btn" onclick="goBack()">‚¨Ö</button>
      <div id="custTitle" style="font-size: 20px; font-weight: bold; flex: 1; text-align: center;"></div>
      <div style="display: flex; gap: 8px;">
        <button class="btn save-btn" onclick="saveNotes()">üíæ</button>
        <button class="btn pdf-btn" onclick="exportPDF()">üìÑ</button>
      </div>
    </div>
    
    <div style="padding: 12px; background: #f8f9fa; margin: 12px; border-radius: 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <input type="date" id="noteDate">
      <div id="todayLabel" style="font-size: 14px; font-weight: bold; color: #666;"></div>
      <button class="btn add-btn" onclick="openAddNoteModal()" style="margin-left: auto;">‚ûï Note</button>
    </div>
    
    <div id="notesBox"></div>
  </div>

</div>

<!-- UNIVERSAL MODAL -->
<div id="universalModal" class="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal-box" id="modalBox" onclick="event.stopPropagation()">
    <div class="modal-handle" id="modalHandle"></div>
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Title</h3>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
    <div class="modal-footer" id="modalFooter">
      <!-- Dynamic buttons -->
    </div>
  </div>
</div>

<script>
const initialList = [
  {code:"AMS01",name:"‡§∏‡§ø‡§ß‡§® ‡§≠‡•á‡§ü‡•á‡§ï‡§∞"},{code:"AMS02",name:"‡§Ö‡§®‡§ø‡§ï‡•á‡§§ ‡§¶‡•Å‡§ß"},
  {code:"AMS03",name:"‡§Æ‡•ã‡§†‡•á ‡§ú‡§æ‡§µ‡§® ‡§∏‡§∞"},{code:"AMS04",name:"‡§∏‡§π‡•ç‡§Ø‡§æ‡§¶‡•ç‡§∞‡•Ä ‡§¶‡•Å‡§ß"},
  {code:"AMS05",name:"‡§∏‡§π‡•ç‡§Ø‡§æ‡§¶‡•ç‡§∞‡•Ä ‡§Æ‡•Ö‡§°‡§Æ"},{code:"AMS06",name:"‡§¶‡•Å‡§ß ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§™‡•Ç‡§ú‡§æ"},
  {code:"AMS07",name:"‡§ë‡§´‡§ø‡§∏"},{code:"AMS08",name:"‡§∞‡§æ‡§ú‡•Ç ‡§Æ‡•á‡§ï‡•Ö‡§®‡§ø‡§ï"},
  {code:"AMS09",name:"‡§Æ‡•ã‡§†‡•á ‡§ú‡§æ‡§ß‡§µ‡§∏‡§∞ ‡§ú‡§µ‡§≥"},{code:"AMS10",name:"‡§¶‡•Å‡§ß ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§®‡§µ‡•Ä‡§®"},
  {code:"AMS11",name:"‡§∞‡§µ‡•Ä ‡§≠‡•à‡§Ø‡§æ ‡§¨‡§æ‡§ú‡•Ç‡§ö‡•á"},{code:"AMS12",name:"‡§≠‡•á‡§ü‡•á‡§ï‡§∞ ‡§Æ‡•Ö‡§°‡§Æ"},
  {code:"AMS13",name:"‡§∞‡§µ‡•Ä ‡§≠‡•à‡§Ø‡•ç‡§Ø‡§æ"},{code:"AMS14",name:"‡§™‡§µ‡§æ‡§∞ ‡§®‡§ó‡§∞ ‡§Æ‡•Ö‡§°‡§Æ"},
  {code:"AMS15",name:"‡§≠‡§æ‡§ä ‡§≠‡•à‡§Ø‡•ç‡§Ø‡§æ ‡§¶‡•Å‡§ß"},{code:"AMS16",name:"‡§ó‡•ã‡§™‡§æ‡§≥ ‡§≠‡•à‡§Ø‡§æ ‡§™‡§æ‡§∂‡•Ä"},
  {code:"AMS17",name:"‡§∞‡§æ‡§†‡•ã‡§° ‡§∏‡§∞"},{code:"AMS18",name:"‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä ‡§µ‡§æ‡§≤‡•ç‡§Ø‡§æ‡§ö‡•ç‡§Ø‡§æ"},
  {code:"AMS19",name:"‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§≠‡§æ‡§¶‡§æ"},{code:"AMS20",name:"‡§Ü‡§≤‡§Æ‡§≤‡§æ ‡§∞‡•ã‡§° ‡•ß"},
  {code:"AMS21",name:"‡§Ü‡§≤‡§Æ‡§≤‡§æ ‡§∞‡•ã‡§° ‡•®"},{code:"AMS22",name:"‡§ú‡§æ‡§ß‡§µ ‡§∏‡§∞ ‡§ó‡§≤‡•ç‡§≤‡•Ä"},
  {code:"AMS23",name:"‡§π‡•ã‡§≥‡§ï‡§∞ ‡§ó‡§≤‡•ç‡§≤‡•Ä ‡•ßL"},{code:"AMS24",name:"‡§Ö‡§Æ‡•ã‡§≤ ‡§∏‡§∞ ‡§¶‡•Å‡§ß"},
  {code:"AMS25",name:"‡§Ü‡§ï‡§æ‡§∂ ‡§¨‡§ø‡§∞‡§æ‡§ú‡§¶‡§æ‡§∞"},{code:"AMS26",name:"‡§ö‡§µ‡•ç‡§π‡§æ‡§£ ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞"},
  {code:"AMS27",name:"‡§Ü‡§ï‡§æ‡§∂ ‡§ò‡§∞‡§æ‡§™‡§æ‡§∂‡•Ä"},{code:"AMS28",name:"‡§ï‡•ã‡§≥‡•Ä ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞"},
  {code:"AMS29",name:"‡§∏‡§æ‡§≥‡•Å‡§Ç‡§ï‡•á ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞"},{code:"AMS30",name:"‡§µ‡§ø‡§†‡•ç‡§†‡§≤ ‡§Æ‡§æ‡§Æ‡§æ"},
  {code:"AMS31",name:"‡§∞‡§æ‡§†‡•ã‡§° ‡§∏‡§∞ ‡•ß/‡•®-‡•ß"},{code:"AMS32",name:"‡§∞‡§æ‡§†‡•ã‡§° ‡§∏‡§∞ ‡•ß/‡•®-‡•®"},
  {code:"AMS33",name:"‡§∞‡§ø‡§ï‡•ç‡§∑‡§æ‡§µ‡§æ‡§≤‡•á ‡§®‡§µ‡•Ä‡§®"},{code:"AMS34",name:"‡§ó‡•ã‡§™‡§æ‡§≥ ‡§≠‡•à‡§Ø‡§æ ‡•®"},
  {code:"AMS35",name:"‡§Æ‡§π‡§æ‡§∞‡•Å‡§¶‡•ç‡§∞ ‡§¨‡•á‡§°‡§ú‡§µ‡§≥‡§ó‡•á"},{code:"AMS36",name:"‡§ó‡§Ç‡§™‡•Ç ‡§¨‡§ø‡§∞‡§æ‡§ú‡§¶‡§æ‡§∞"},
  {code:"AMS37",name:"‡§¨‡§∏ ‡§∏‡•ç‡§ü‡§Å‡§° ‡§î‡§∏‡§æ"},{code:"AMS38",name:"‡§¨‡§æ‡§≤‡§æ‡§ú‡•Ä ‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§ï"},
  {code:"AMS39",name:"‡§Ö‡§≤‡§Æ‡§≤‡§æ ‡§∏‡§∞ ‡§µ‡•à‡§ú‡§µ‡§æ‡§°‡•á"},{code:"AMS40",name:"‡§™‡§æ‡§ü‡•Ä‡§≤ ‡§ó‡§≤‡•ç‡§≤‡•Ä ‡•ß"}
];

let customers = JSON.parse(localStorage.getItem("cust_list")) || initialList;
let notesData = JSON.parse(localStorage.getItem("cust_notes")) || {};
let currentIndex = null;
let currentNoteIndex = null;
let modalMode = ''; // 'editCust', 'addCust', 'addNote', 'delNote'

// Modal Drag/Swipe Logic
let isDragging = false;
let startY = 0;
let currentY = 0;
let modalBox = document.getElementById('modalBox');
let modalHandle = document.getElementById('modalHandle');

modalHandle.addEventListener('mousedown', startDrag);
modalHandle.addEventListener('touchstart', startDrag, {passive: false});

function startDrag(e) {
  isDragging = true;
  startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
  modalBox.style.transition = 'none';
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', stopDrag);
  document.addEventListener('touchmove', drag, {passive: false});
  document.addEventListener('touchend', stopDrag);
}

function drag(e) {
  if (!isDragging) return;
  e.preventDefault();
  currentY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
  let diff = currentY - startY;
  if (diff > 0) { // Only allow downward drag
    modalBox.style.transform = `translateY(${diff}px) scale(${1 - diff/1000})`;
  }
}

function stopDrag(e) {
  if (!isDragging) return;
  isDragging = false;
  modalBox.style.transition = 'transform 0.3s';
  let diff = currentY - startY;
  if (diff > 100) {
    closeModal();
  } else {
    modalBox.style.transform = 'scale(1) translateY(0)';
  }
  document.removeEventListener('mousemove', drag);
  document.removeEventListener('mouseup', stopDrag);
  document.removeEventListener('touchmove', drag);
  document.removeEventListener('touchend', stopDrag);
}

function openModal() {
  document.getElementById('universalModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('universalModal').classList.remove('active');
  document.body.style.overflow = '';
  setTimeout(() => {
    modalBox.style.transform = '';
  }, 300);
}

// Block outside click from closing
function handleOverlayClick(e) {
  // Do nothing - modal only closes via X button, Save, Delete, or swipe down
  e.stopPropagation();
}

// Render Customer List
function renderList() {
  const box = document.getElementById("custList");
  box.innerHTML = "";
  if (customers.length === 0) {
    box.innerHTML = '<div class="empty-state">‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§®‡§æ‡§π‡•Ä‡§§<br>‚ûï ‡§µ‡§æ‡§™‡§∞‡•Ç‡§® ‡§®‡§µ‡•Ä‡§® ‡§ü‡§æ‡§ï‡§æ</div>';
    return;
  }
  customers.forEach((c, i) => {
    const d = document.createElement("div");
    d.className = "list-item";
    d.innerHTML = `
      <div style="flex: 1;" onclick="openCustomer(${i})">
        <div style="font-weight: bold; color: #1a73e8;">${c.code}</div>
        <div style="color: #333; margin-top: 4px;">${c.name}</div>
      </div>
      <div class="dots" onclick="openCustMenu(event, ${i})">‚ãÆ</div>
    `;
    box.appendChild(d);
  });
  localStorage.setItem("cust_list", JSON.stringify(customers));
}

// Customer Menu Modal (Edit/Delete)
function openCustMenu(e, i) {
  e.stopPropagation();
  currentIndex = i;
  modalMode = 'editCust';
  const cust = customers[i];
  
  document.getElementById('modalTitle').textContent = '‚úèÔ∏è ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§è‡§°‡§ø‡§ü';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label class="form-label">AMS Code</label>
      <input type="text" class="form-input" id="editCode" value="${cust.code}" placeholder="AMS01">
    </div>
    <div class="form-group">
      <label class="form-label">‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§®‡§æ‡§µ</label>
      <input type="text" class="form-input" id="editName" value="${cust.name}" placeholder="‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ">
    </div>
  `;
  document.getElementById('modalFooter').innerHTML = `
    <button class="btn delete-btn" onclick="deleteCust()">üóë Delete</button>
    <button class="btn save-btn" onclick="saveCustEdit()">üíæ Save</button>
  `;
  openModal();
}

function saveCustEdit() {
  const newCode = document.getElementById('editCode').value.trim();
  const newName = document.getElementById('editName').value.trim();
  
  if (!newName) {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ!');
    return;
  }
  
  // Update notes key if code changed
  const oldCode = customers[currentIndex].code;
  if (oldCode !== newCode && notesData[oldCode]) {
    notesData[newCode] = notesData[oldCode];
    delete notesData[oldCode];
  }
  
  customers[currentIndex].code = newCode || oldCode;
  customers[currentIndex].name = newName;
  
  localStorage.setItem("cust_list", JSON.stringify(customers));
  localStorage.setItem("cust_notes", JSON.stringify(notesData));
  renderList();
  closeModal();
}

function deleteCust() {
  if (confirm("‡§ñ‡§æ‡§§‡•ç‡§∞‡•Ä ‡§Ü‡§π‡•á ‡§ï‡§æ? ‡§π‡§æ ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§ï‡§æ‡§Ø‡§Æ‡§ö‡§æ delete ‡§π‡•ã‡§à‡§≤!")) {
    const code = customers[currentIndex].code;
    customers.splice(currentIndex, 1);
    delete notesData[code];
    localStorage.setItem("cust_list", JSON.stringify(customers));
    localStorage.setItem("cust_notes", JSON.stringify(notesData));
    renderList();
    closeModal();
  }
}

// Add Customer Modal
function openAddCustomerModal() {
  modalMode = 'addCust';
  document.getElementById('modalTitle').textContent = '‚ûï ‡§®‡§µ‡•Ä‡§® ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label class="form-label">AMS Code (‡§ë‡§ü‡•ã ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§Æ‡•Ö‡§®‡•Å‡§Ö‡§≤)</label>
      <input type="text" class="form-input" id="newCode" placeholder="‡§â‡§¶‡§æ. AMS41">
    </div>
    <div class="form-group">
      <label class="form-label">‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§®‡§æ‡§µ *</label>
      <input type="text" class="form-input" id="newName" placeholder="‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ">
    </div>
  `;
  document.getElementById('modalFooter').innerHTML = `
    <button class="btn back-btn" onclick="closeModal()">Cancel</button>
    <button class="btn save-btn" onclick="saveNewCust()">‚ûï Add</button>
  `;
  // Auto-generate next code
  const nextNum = customers.length + 1;
  document.getElementById('newCode').value = "AMS" + String(nextNum).padStart(2, "0");
  openModal();
}

function saveNewCust() {
  const code = document.getElementById('newCode').value.trim();
  const name = document.getElementById('newName').value.trim();
  
  if (!name) {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ!');
    return;
  }
  if (!code) {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ code ‡§ü‡§æ‡§ï‡§æ!');
    return;
  }
  
  // Check duplicate code
  if (customers.find(c => c.code === code)) {
    alert('‡§π‡§æ code ‡§Ü‡§ß‡•Ä‡§™‡§æ‡§∏‡•Ç‡§® ‡§Ü‡§π‡•á! ‡§¶‡•Å‡§∏‡§∞‡§æ ‡§µ‡§æ‡§™‡§∞‡§æ.');
    return;
  }
  
  customers.push({code, name});
  localStorage.setItem("cust_list", JSON.stringify(customers));
  renderList();
  closeModal();
}

// Open Customer Detail Page
function openCustomer(i) {
  currentIndex = i;
  document.getElementById("todayLabel").innerText = getTodayDDMMYYYY();
  document.getElementById("noteDate").value = new Date().toISOString().split("T")[0];
  document.getElementById("pageList").classList.add("hidden");
  document.getElementById("pageDetail").classList.remove("hidden");
  document.getElementById("custTitle").innerText = customers[i].code + " - " + customers[i].name;
  renderNotes();
}

function goBack() {
  document.getElementById("pageDetail").classList.add("hidden");
  document.getElementById("pageList").classList.remove("hidden");
  currentIndex = null;
}

// Render Notes
function renderNotes() {
  const box = document.getElementById("notesBox");
  box.innerHTML = "";
  const key = customers[currentIndex].code;
  const notes = notesData[key] || [];
  
  if (notes.length === 0) {
    box.innerHTML = '<div class="empty-state">‡§Ö‡§ú‡•Ç‡§® ‡§ï‡•ã‡§£‡§§‡•Ä‡§π‡•Ä note ‡§®‡§æ‡§π‡•Ä<br>‡§µ‡§∞‡§ö‡•ç‡§Ø‡§æ ‚ûï button ‡§µ‡§æ‡§™‡§∞‡§æ</div>';
    return;
  }
  
  notes.forEach((n, idx) => {
    const d = document.createElement("div");
    d.className = "note";
    d.innerHTML = `
      <div class="note-dots" onclick="openNoteMenu(event, ${idx})">‚ãÆ</div>
      <div class="note-header">
        <span class="note-date">üìÖ ${n.date}</span>
      </div>
      <div class="note-text">${n.text}</div>
    `;
    box.appendChild(d);
  });
}

// Note Menu (Delete)
function openNoteMenu(e, idx) {
  e.stopPropagation();
  currentNoteIndex = idx;
  modalMode = 'delNote';
  const note = notesData[customers[currentIndex].code][idx];
  
  document.getElementById('modalTitle').textContent = '‚ö†Ô∏è Note ‡§ï‡§æ‡§¢‡•Ç‡§® ‡§ü‡§æ‡§ï‡§æ?';
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-small">
      <div class="warning-icon">üóëÔ∏è</div>
      <p><b>Date:</b> ${note.date}</p>
      <p style="color: #666; margin-top: 10px;">${note.text}</p>
      <p style="color: #dc3545; margin-top: 15px; font-size: 14px;">‡§π‡•á ‡§™‡§∞‡§§ ‡§Ø‡•á‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä!</p>
    </div>
  `;
  document.getElementById('modalFooter').innerHTML = `
    <button class="btn back-btn" onclick="closeModal()">Cancel</button>
    <button class="btn delete-btn" onclick="confirmDeleteNote()">Delete</button>
  `;
  openModal();
}

function confirmDeleteNote() {
  const key = customers[currentIndex].code;
  notesData[key].splice(currentNoteIndex, 1);
  if (notesData[key].length === 0) delete notesData[key];
  localStorage.setItem("cust_notes", JSON.stringify(notesData));
  renderNotes();
  closeModal();
}

// Add Note Modal
function openAddNoteModal() {
  modalMode = 'addNote';
  const today = document.getElementById('noteDate').value;
  const displayDate = formatDateDisplay(today);
  
  document.getElementById('modalTitle').textContent = '‚ûï ‡§®‡§µ‡•Ä‡§® Note';
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group">
      <label class="form-label">Date</label>
      <input type="text" class="form-input" value="${displayDate}" readonly style="background: #f5f5f5;">
    </div>
    <div class="form-group">
      <label class="form-label">‡§§‡§™‡§∂‡•Ä‡§≤ *</label>
      <textarea class="form-input" id="noteText" placeholder="‡§Ü‡§ú ‡§ï‡§ø‡§§‡•Ä ‡§¶‡•Ç‡§ß ‡§¶‡§ø‡§≤‡•á / Extra ‡§¶‡•Ç‡§ß / ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü..."></textarea>
    </div>
  `;
  document.getElementById('modalFooter').innerHTML = `
    <button class="btn back-btn" onclick="closeModal()">Cancel</button>
    <button class="btn save-btn" onclick="saveNewNote()">üíæ Save</button>
  `;
  openModal();
}

function saveNewNote() {
  const dateVal = document.getElementById('noteDate').value;
  const txt = document.getElementById('noteText').value.trim();
  
  if (!txt) {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§™‡§∂‡•Ä‡§≤ ‡§≤‡§ø‡§π‡§æ!');
    return;
  }
  if (!dateVal) {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ date ‡§®‡§ø‡§µ‡§°‡§æ!');
    return;
  }
  
  const displayDate = formatDateDisplay(dateVal);
  const key = customers[currentIndex].code;
  
  if (!notesData[key]) notesData[key] = [];
  notesData[key].push({date: displayDate, text: txt});
  
  // Sort by date (newest first)
  notesData[key].sort((a, b) => {
    const da = parseDate(a.date);
    const db = parseDate(b.date);
    return db - da;
  });
  
  localStorage.setItem("cust_notes", JSON.stringify(notesData));
  renderNotes();
  closeModal();
}

function formatDateDisplay(dateStr) {
  // dateStr is YYYY-MM-DD, convert to DD-MM-YYYY
  const [yyyy, mm, dd] = dateStr.split('-');
  return `${dd}-${mm}-${yyyy}`;
}

function parseDate(dateStr) {
  // dateStr is DD-MM-YYYY
  const [dd, mm, yyyy] = dateStr.split('-');
  return new Date(`${yyyy}-${mm}-${dd}`);
}

function getTodayDDMMYYYY() {
  const d = new Date();
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

function saveNotes() {
  localStorage.setItem("cust_notes", JSON.stringify(notesData));
  
  // Show mini confirmation instead of alert
  const btn = event.target;
  const original = btn.textContent;
  btn.textContent = '‚úì Saved';
  btn.style.background = '#28a745';
  setTimeout(() => {
    btn.textContent = original;
    btn.style.background = '';
  }, 1500);
}

function exportPDF() {
  const element = document.getElementById("pageDetail");
  const opt = {
    margin: 10,
    filename: customers[currentIndex].code + '_report.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
}

// Initialize
renderList();
</script>

</body>
</html>